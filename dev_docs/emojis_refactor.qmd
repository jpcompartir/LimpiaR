---
title: "Emojis Refactor"
format:
  html:
    embed-resources: true
---
# Emojis Refactor
```{r, emojis_tst_cases}
test_cases_emojis<- c(
  "Hello ðŸ‘‹ world", # Single emoji
  "Family: ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦", # Complex multi-picture emoji
  "âœ¨â­ï¸ðŸŒŸ stars", # Multiple single emojis
  "cafÃ© â„– Ï€", # Special characters
  "Flag: ðŸ‡ºðŸ‡¸", # Flag emoji
  "Skin tone: ðŸ‘ðŸ½", # Emoji with modifier
  "ðŸ‘¨ðŸ¾â€ðŸ’» coding", # Professional emoji with skin tone
  "â¤ï¸ heart", # Heart with variation selector
  "ÂµmÂ³ Ã¸re", # Scientific/foreign characters
  "ðŸ˜€ ðŸ«¥ ðŸ«¡", # Mix of old and new emojis
   "Family combos: ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸ‘©â€ðŸ‘©â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘§",
  "Skin tones: ðŸ‘‹ðŸ» ðŸ‘‹ðŸ¼ ðŸ‘‹ðŸ½ ðŸ‘‹ðŸ¾ ðŸ‘‹ðŸ¿",
  "Professional + skin: ðŸ‘¨ðŸ½â€ðŸ’» ðŸ‘©ðŸ¾â€ðŸ”¬ ðŸ‘¨ðŸ¿â€ðŸŒ¾",
  "ZWJ sequences: ðŸ‘¨â€â¤ï¸â€ðŸ‘¨ ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘©",
  "Flags: ðŸ³ï¸â€ðŸŒˆ ðŸ³ï¸â€âš§ï¸ ðŸ‡ºðŸ‡¸ ðŸ‡¯ðŸ‡µ",
  "Activities: ðŸ¤¾ðŸ½â€â™€ï¸ ðŸŠðŸ¿â€â™‚ï¸ ðŸš´ðŸ»â€â™€ï¸",
  "Special chars keep: cafÃ© Ï€ ÂµmÂ³ Ç½ Ã† ÃŸ",
  "Mixed: Ï€ðŸ‘©ðŸ½â€ðŸ”¬âˆšÏ‰ âˆ‘ðŸ§ª",
  "New emojis: ðŸ«¡ ðŸ«‚ ðŸ«  ðŸª© ðŸª¿",
  "Hearts: â¤ï¸ ðŸ’ ðŸ’– ðŸ’—"
)
```


```{r special_chars}
test_cases_special_chars <- c(
    "Hello ðŸ‘‹ World",           # Basic emoji - caught by all three patterns
    "CafÃ© au lait",            # Accented 'e' - caught by pattern 2 only
    "Star â­ power",           # Unicode star - caught by patterns 2 and 3
    "Face ðŸ˜€ vs star â­",      # Multiple symbols - different patterns
    "æ ‘ means tree",           # Chinese character - caught by pattern 2
    "Music â™« note",           # Musical symbol - caught by patterns 2 and 3
    "100% done ðŸ‘",           # Emoji with ASCII symbols
    "Weather: ðŸŒžâ˜”",          # Multiple emoji - all patterns
    "â†‘â†“â†’â†",                  # Arrow symbols - patterns 2 and 3
    "Normal ASCII text!",      # Control case - no matches
    "Family: ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ at home",    # Family emoji (multiple people joined)
    "Jobs: ðŸ‘¨ðŸ½â€ðŸ’» ðŸ‘©ðŸ¾â€ðŸŒ¾ ðŸ‘¨ðŸ¿â€ðŸ³",      # Professional emojis with skin tone modifiers
    "Love ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨ story",         # Kiss emoji (two people joined with heart)
    "ðŸ³ï¸â€ðŸŒˆ Pride & ðŸ³ï¸â€âš§ï¸ Rights",    # Pride and trans flags (complex flag emojis)
    "Science ðŸ§¬ and ðŸ§ª with ðŸ«§",    # Newer Unicode emojis (DNA, test tube, bubbles)
    "æ—¥æœ¬èªžã®å‹‰å¼· ðŸ“š with å…ˆç”Ÿ",      # Japanese (studying Japanese with teacher)
    "ÐŸÑ€Ð¸Ð²ÐµÑ‚ ðŸ‘‹ Ð¼Ð¸Ñ€! â­",            # Russian (Hello world!)
    "æˆ‘å–œæ¬¢å–å’–å•¡ â˜• å’ŒèŒ¶ ðŸ«–",         # Chinese (I like coffee and tea)
    "ì•ˆë…•í•˜ì„¸ìš” ðŸ™‡â€â™‚ï¸ ì¹œêµ¬ì•¼",          # Korean (Hello friend) with bowing emoji
    "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù… ðŸŒ ØµØ¯ÙŠÙ‚ÙŠ",       # Arabic (Hello world my friend)
    "ÎšÎ±Î»Î·Î¼Î­ÏÎ± ðŸŒ… ÎºÏŒÏƒÎ¼Îµ",           # Greek (Good morning world)
    "×ª×¤×•×— ðŸŽ ×•×œ×—× ðŸž",              # Hebrew (apple and bread)
    "à¤¨à¤®à¤¸à¥à¤¤à¥‡ à¤¦à¥à¤¨à¤¿à¤¯à¤¾ ðŸ™ à¤¶à¤¾à¤‚à¤¤à¤¿",        # Hindi (Hello world peace)
    "à¹„à¸›à¸à¸´à¸™à¸‚à¹‰à¸²à¸§ ðŸœ à¸à¸±à¸™",             # Thai (Let's go eat)
    "áž‡áž½áž”áž‚áŸ’áž“áž¶ážáŸ’áž„áŸƒáž€áŸ’ážšáŸ„áž™ ðŸ‘‹ ážŸáž¼áž˜áž”áž„áŸ’áž áž¶áž‰"  , #khmer stuff
    "Hello Ã©tudiant ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",    # French accents with Arabic
    "MÃ¼nchen ist schÃ¶n åŸŽå¸‚",       # German umlauts with Chinese
    "cafÃ© ÎºÎ±Î¹ ÏƒÏ€Î¯Ï„Î¹",              # French accent with Greek
    "ChÃ¢teau pÃ¥ bjÃ¶rnen",          # French and Swedish accents
    "Ñ€ÑƒÑÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº",                # Russian
    "æ¼¢å­— ã¨ ã²ã‚‰ãŒãª",              # Chinese and Japanese
    "La niÃ±a estÃ¡ å’Œ ì•ˆë…•",         # Spanish accents with Chinese and Korean
   "Hello Ã©tudiant ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",    # French accents with Arabic
    "MÃ¼nchen ist schÃ¶n åŸŽå¸‚",       # German umlauts with Chinese
    "cafÃ© ÎºÎ±Î¹ ÏƒÏ€Î¯Ï„Î¹",              # French accent with Greek
    "ChÃ¢teau pÃ¥ bjÃ¶rnen",          # French and Swedish accents
    "Ñ€ÑƒÑÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº",                # Russian
    "æ¼¢å­— ã¨ ã²ã‚‰ãŒãª",              # Chinese and Japanese
    "La niÃ±a estÃ¡ å’Œ ì•ˆë…•",         # Spanish accents with Chinese and Korean
    "CrÃ¨me brÃ»lÃ©e ðŸ®"              # French accents with emoji

)
```

```{r, extended_pattern_1}
library(stringi)

cleaned_claude_1 <- gsub("[\\p{Emoji_Presentation}\\p{Extended_Pictographic}]", "", test_cases_emojis)
cleaned_claude_2 <- stri_replace_all_regex(test_cases, "[\U{1F300}-\U{1F9FF}]", "")

extended_pattern <- paste0(
  "[\U{1F000}-\U{1FFFF}]",                       # Main emoji blocks
  "|[\U{2190}-\U{27BF}]",                        # Arrows, symbols
  "|[\U{2B00}-\U{2BFF}]",                        # Misc symbols
  "|[\U{1F1E6}-\U{1F1FF}]",                      # Regional indicators
  "|[\U{1F300}-\U{1F5FF}]",                      # Additional emoji
  "|[\U{1F600}-\U{1F64F}]",                      # Emoticons
  "|[\U{1F680}-\U{1F6FF}]",                      # Transport
  "|[\U{1F900}-\U{1F9FF}]",                      # Supplemental
  "|[\U{1FA00}-\U{1FA6F}]",                      # Extended-A
  "|[\U{1FA70}-\U{1FAFF}]",                      # Extended-B
  "|[\U{FE00}-\U{FE0F}]"                         # Variation selectors
)
cleaned_extended_pattern <- stringr::str_remove_all(test_cases_emojis, extended_pattern)
```

```{r extended_pattern_2}
extended_pattern_2 <- pattern <- paste0(
  "[\U{1F000}-\U{1FFFF}]",                       # Main emoji blocks
  "|[\U{2190}-\U{27BF}]",                        # Arrows, symbols
  "|[\U{2B00}-\U{2BFF}]",                        # Misc symbols
  "|[\U{1F1E6}-\U{1F1FF}]",                      # Regional indicators
  "|[\U{1F300}-\U{1F5FF}]",                      # Additional emoji
  "|[\U{1F600}-\U{1F64F}]",                      # Emoticons
  "|[\U{1F680}-\U{1F6FF}]",                      # Transport
  "|[\U{1F900}-\U{1F9FF}]",                      # Supplemental
  "|[\U{1FA00}-\U{1FA6F}]",                      # Extended-A
  "|[\U{1FA70}-\U{1FAFF}]",                      # Extended-B
  "|[\U{FE00}-\U{FE0F}]",                        # Variation selectors
  "|[\U{E0020}-\U{E007F}]",                      # Tags
  "|[\U{200D}]",                                 # Zero Width Joiner
  "|[\U{20D0}-\U{20FF}]"                         # Combining marks
)
cleaned_extended_pattern_2 <- stringr::str_remove_all(test_cases_emojis, extended_pattern_2)
```

```{r, extended_test_caeses}
test_cases_extended <- c(
  "ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",  # Family emoji (better handling of ZWJ)
  "ðŸ³ï¸â€âš§ï¸",      # Trans flag (combination of tag sequences)
  "1ï¸âƒ£",        # Keycap number (combining marks)
  "ðŸ‘©ðŸ½â€ðŸ”¬",      # Professional with skin tone (ZWJ + modifier)
  "ðŸ«±ðŸ¼â€ðŸ«²ðŸ¾"      # Handshake with different skin tones (complex ZWJ)
)
```

```{r}
tibble(
  cases = test_cases_extended,
  x = stringr::str_remove_all(test_cases_extended, extended_pattern),
  y = stringr::str_remove_all(test_cases_extended, extended_pattern_2)
)
```

```{r, mixed_special_chars_emojis}
mixed_cases <- c(
    "Hello ðŸ‘‹ World",           # Basic emoji - caught by all three patterns
    "CafÃ© au lait",            # Accented 'e' - caught by pattern 2 only
    "Star â­ power",           # Unicode star - caught by patterns 2 and 3
    "Face ðŸ˜€ vs star â­",      # Multiple symbols - different patterns
    "æ ‘ means tree",           # Chinese character - caught by pattern 2
    "Music â™« note",           # Musical symbol - caught by patterns 2 and 3
    "100% done ðŸ‘",           # Emoji with ASCII symbols
    "Weather: ðŸŒžâ˜”",          # Multiple emoji - all patterns
    "â†‘â†“â†’â†",                  # Arrow symbols - patterns 2 and 3
    "Normal ASCII text!",      # Control case - no matches
    "Family: ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ at home",    # Family emoji (multiple people joined)
    "Jobs: ðŸ‘¨ðŸ½â€ðŸ’» ðŸ‘©ðŸ¾â€ðŸŒ¾ ðŸ‘¨ðŸ¿â€ðŸ³",      # Professional emojis with skin tone modifiers
    "Love ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘¨ story",         # Kiss emoji (two people joined with heart)
    "ðŸ³ï¸â€ðŸŒˆ Pride & ðŸ³ï¸â€âš§ï¸ Rights",    # Pride and trans flags (complex flag emojis)
    "Science ðŸ§¬ and ðŸ§ª with ðŸ«§",    # Newer Unicode emojis (DNA, test tube, bubbles)
    "æ—¥æœ¬èªžã®å‹‰å¼· ðŸ“š with å…ˆç”Ÿ",      # Japanese (studying Japanese with teacher)
    "ÐŸÑ€Ð¸Ð²ÐµÑ‚ ðŸ‘‹ Ð¼Ð¸Ñ€! â­",            # Russian (Hello world!)
    "æˆ‘å–œæ¬¢å–å’–å•¡ â˜• å’ŒèŒ¶ ðŸ«–",         # Chinese (I like coffee and tea)
    "ì•ˆë…•í•˜ì„¸ìš” ðŸ™‡â€â™‚ï¸ ì¹œêµ¬ì•¼",          # Korean (Hello friend) with bowing emoji
    "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø§Ù„Ø¹Ø§Ù„Ù… ðŸŒ ØµØ¯ÙŠÙ‚ÙŠ",       # Arabic (Hello world my friend)
    "ÎšÎ±Î»Î·Î¼Î­ÏÎ± ðŸŒ… ÎºÏŒÏƒÎ¼Îµ",           # Greek (Good morning world)
    "×ª×¤×•×— ðŸŽ ×•×œ×—× ðŸž",              # Hebrew (apple and bread)
    "à¤¨à¤®à¤¸à¥à¤¤à¥‡ à¤¦à¥à¤¨à¤¿à¤¯à¤¾ ðŸ™ à¤¶à¤¾à¤‚à¤¤à¤¿",        # Hindi (Hello world peace)
    "à¹„à¸›à¸à¸´à¸™à¸‚à¹‰à¸²à¸§ ðŸœ à¸à¸±à¸™",             # Thai (Let's go eat)
    "áž‡áž½áž”áž‚áŸ’áž“áž¶ážáŸ’áž„áŸƒáž€áŸ’ážšáŸ„áž™ ðŸ‘‹ ážŸáž¼áž˜áž”áž„áŸ’áž áž¶áž‰"  , #khmer stuff
    "Hello Ã©tudiant ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",    # French accents with Arabic
    "MÃ¼nchen ist schÃ¶n åŸŽå¸‚",       # German umlauts with Chinese
    "cafÃ© ÎºÎ±Î¹ ÏƒÏ€Î¯Ï„Î¹",              # French accent with Greek
    "ChÃ¢teau pÃ¥ bjÃ¶rnen",          # French and Swedish accents
    "Ñ€ÑƒÑÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº",                # Russian
    "æ¼¢å­— ã¨ ã²ã‚‰ãŒãª",              # Chinese and Japanese
    "La niÃ±a estÃ¡ å’Œ ì•ˆë…•",         # Spanish accents with Chinese and Korean
   "Hello Ã©tudiant ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",    # French accents with Arabic
    "MÃ¼nchen ist schÃ¶n åŸŽå¸‚",       # German umlauts with Chinese
    "cafÃ© ÎºÎ±Î¹ ÏƒÏ€Î¯Ï„Î¹",              # French accent with Greek
    "ChÃ¢teau pÃ¥ bjÃ¶rnen",          # French and Swedish accents
    "Ñ€ÑƒÑÑÐºÐ¸Ð¹ ÑÐ·Ñ‹Ðº",                # Russian
    "æ¼¢å­— ã¨ ã²ã‚‰ãŒãª",              # Chinese and Japanese
    "La niÃ±a estÃ¡ å’Œ ì•ˆë…•",         # Spanish accents with Chinese and Korean
    "CrÃ¨me brÃ»lÃ©e ðŸ®"              # French accents with emoji
)

mixed_tib <- tibble(case = mixed_cases)
```

```{r}
names(mixed_tib)
mixed_tib %>%
  limpiar_remove_emojis(text_var = case) %>%
  as.data.frame()

```

```{r}
non_ <- mixed_tib %>%
  limpiar_non_ascii(case) %>%
  as.data.frame()

non_trim <- mixed_tib %>%
  limpiar_non_ascii_trim(case) %>%
  as.data.frame()

identical(non_,non_trim)

trust_df <- read_csv("~/Google Drive/My Drive/data_science_project_work/microsoft/project_work/789_taxonomy_of_spam/data/project_samples/trust_distrust_757_100k_sample.csv")
```


```{r}
start <- Sys.time()
cleaned  <- trust_df %>%
  limpiar_non_ascii_trim(message)
end <- Sys.time()
end - start 

high_emojis <- trust_df %>%
  mutate(count_emojis = str_count(message, emojis_pattern)) %>%
  arrange(desc(count_emojis)) %>%
  filter(count_emojis > 20)

high_emojis %>% 
  slice(1) %>%
  # pull(message)
  # limpiar_non_ascii(message) %>%
  limpiar_alphanumeric(message) %>%
  pull(message)
```

The unextended version is actually better:
```{r}
tibble(
  cases = mixed_cases,
  x = stringr::str_remove_all(mixed_cases, extended_pattern),
  y = stringr::str_remove_all(mixed_cases, extended_pattern_2)
) %>%
  as.data.frame()
```

Verify some of the emoji regexs
```{r}
emojis_pattern <- list(
    main_blocks = "[\U{1F000}-\U{1FFFF}]",          # Main emoji blocks
    arrows_symbols = "[\U{2190}-\U{27BF}]",         # Arrows, symbols
    misc_symbols = "[\U{2B00}-\U{2BFF}]",           # Misc symbols
    regional = "[\U{1F1E6}-\U{1F1FF}]",             # Regional indicators
    additional = "[\U{1F300}-\U{1F5FF}]",           # Additional emoji
    emoticons = "[\U{1F600}-\U{1F64F}]",            # Emoticons
    transport = "[\U{1F680}-\U{1F6FF}]",            # Transport
    supplemental = "[\U{1F900}-\U{1F9FF}]",         # Supplemental
    extended_a = "[\U{1FA00}-\U{1FA6F}]",           # Extended-A
    extended_b = "[\U{1FA70}-\U{1FAFF}]",           # Extended-B
    variation = "[\U{FE00}-\U{FE0F}]"               # Variation selectors
)

# Function to view matches for each pattern
view_matches <- function(text) {
  purrr::imap(emojis_pattern, ~ {
    cat("\nPattern:", .y, "\n")
    print(stringr::str_view_all(text, stringr::regex(.x)))
  })
}
view_matches
```


```{r}
# Create named list of patterns
emojis_pattern <- list(
    main_blocks = "[\U{1F000}-\U{1FFFF}]",          # Main emoji blocks
    arrows_symbols = "[\U{2190}-\U{27BF}]",         # Arrows, symbols
    misc_symbols = "[\U{2B00}-\U{2BFF}]",           # Misc symbols
    regional = "[\U{1F1E6}-\U{1F1FF}]",             # Regional indicators
    additional = "[\U{1F300}-\U{1F5FF}]",           # Additional emoji
    emoticons = "[\U{1F600}-\U{1F64F}]",            # Emoticons
    transport = "[\U{1F680}-\U{1F6FF}]",            # Transport
    supplemental = "[\U{1F900}-\U{1F9FF}]",         # Supplemental
    extended_a = "[\U{1FA00}-\U{1FA6F}]",           # Extended-A
    extended_b = "[\U{1FA70}-\U{1FAFF}]",           # Extended-B
    variation = "[\U{FE00}-\U{FE0F}]"               # Variation selectors
)

# Function to check matches for a single pattern
check_matches <- function(text, pattern_name, pattern) {
    matches <- stringr::str_extract_all(text, stringr::regex(pattern))
    has_match <- lengths(matches) > 0
    if (any(has_match)) {
        cat("\nPattern:", pattern_name, "\n")
        matched_cases <- text[has_match]
        matches_found <- matches[has_match]
        for (i in seq_along(matched_cases)) {
            cat(sprintf("Test case %2d: %s\n", 
                       which(text == matched_cases[i]), 
                       matched_cases[i]))
            cat("   Matches:", paste(matches_found[[i]], collapse = " "), "\n")
        }
    }
}

# Function to analyse all test cases
analyse_patterns <- function(test_cases) {
    purrr::iwalk(emojis_pattern, ~check_matches(test_cases, .y, .x))
}

test_cases <- c(
    "Hello ðŸ‘‹ world",
    "Family: ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦",
    "âœ¨â­ï¸ðŸŒŸ stars",
    "cafÃ© â„– Ï€",
    "Flag: ðŸ‡ºðŸ‡¸",
    "Skin tone: ðŸ‘ðŸ½",
    "ðŸ‘¨ðŸ¾â€ðŸ’» coding",
    "â¤ï¸ heart",
    "ÂµmÂ³ Ã¸re",
    "ðŸ˜€ \U{01fae5} \U{01fae1}",
    "Family combos: ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ ðŸ‘©â€ðŸ‘©â€ðŸ‘¦ ðŸ‘¨â€ðŸ‘¨â€ðŸ‘§â€ðŸ‘§",
    "Skin tones: ðŸ‘‹ðŸ» ðŸ‘‹ðŸ¼ ðŸ‘‹ðŸ½ ðŸ‘‹ðŸ¾ ðŸ‘‹ðŸ¿",
    "Professional + skin: ðŸ‘¨ðŸ½â€ðŸ’» ðŸ‘©ðŸ¾â€ðŸ”¬ ðŸ‘¨ðŸ¿â€ðŸŒ¾",
    "ZWJ sequences: ðŸ‘¨â€â¤ï¸â€ðŸ‘¨ ðŸ‘©â€â¤ï¸â€ðŸ’‹â€ðŸ‘©",
    "Flags: ðŸ³ï¸â€ðŸŒˆ ðŸ³ï¸â€âš§ï¸ ðŸ‡ºðŸ‡¸ ðŸ‡¯ðŸ‡µ",
    "Activities: ðŸ¤¾ðŸ½â€â™€ï¸ ðŸŠðŸ¿â€â™‚ï¸ ðŸš´ðŸ»â€â™€ï¸",
    "Special chars keep: cafÃ© Ï€ ÂµmÂ³ Ç½ Ã† ÃŸ",
    "Mixed: Ï€ðŸ‘©ðŸ½â€ðŸ”¬âˆšÏ‰ âˆ‘ðŸ§ª",
    "New emojis: \U{01fae1} ðŸ«‚ \U{01fae0} \U{01faa9} \U{01fabf}",
    "Hearts: â¤ï¸ ðŸ’ ðŸ’– ðŸ’—"
)


analyse_patterns(test_cases)
```


```{r}
tibble::tibble(
  original = test_cases,
  method_1 = cleaned_claude_1,
  method_2 = cleaned_claude_2,
  extended_method = cleaned_extended_pattern,
  extended_method_2 = cleaned_extended_pattern_2
)
```




# String Wrapping
For DT:: outputs and plotly etc.?
```{r}
df <- tibble::tibble(x = "LONG POST MADE LONGER LONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGERLONG POST MADE LONGER")

library(tidyverse)
add_br <- function(text, n) {
  words <- str_split(text, " ")[[1]]
  words_with_br <- map_chr(seq_along(words), ~ifelse(. %% n == 0, paste0(words[.], "<br>"), words[.]))
  paste(words_with_br, collapse = " ")
}

df <- df %>%
  mutate(hover_text = map_chr(x, ~add_br(.x, 10)))

df$hover_text


paste0(strwrap(df$x[[1]], width = 150, prefix = "<br>"), collapse = "")
```


